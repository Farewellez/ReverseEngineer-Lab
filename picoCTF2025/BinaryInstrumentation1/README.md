## Binary Instrumentation 1
### Author: Venax
### Tag: Medium, Reverse Engineering, picoCTF 2025

### Description
I have been learning to use the Windows API to do cool stuff! Can you wake up my program to get the flag?
Download the exe <a href="https://challenge-files.picoctf.net/c_verbal_sleep/c71239e2890bd0008ff9c1da986438d276e7a96ba123cb3bc7b04d5a3de27fe7/bininst1.zip">here</a>. Unzip the archive with the password picoctf

## Write-up
Jadi di challenge kali ini kita diminta untuk mencari sebuah flag di dalam file PE32+. Saat dilakukan static analyst di ghidra beberapa offset adddress masih ada yang kosong atau masih semacam stub seperti seolah sedang mempersiapkan kode lainnya. Karena itu langsung jalankan saja via dynamic analyst menggunakan x64dbg di windows

Ketika di F9 sebanyak 4 kali, maka terminal akan stuck dan muncul output ini

```
Hi, I have the flag for you just right here!
I'll just take a quick nap before I print it out for you, should only take me a decade or so!
zzzzzzzz....
```
disini aku baru tau kalau ini sleep setelah memasang beberapa breakpoint sebelum F9 yang ke tiga kali
<img width="1020" height="346" alt="image" src="https://github.com/user-attachments/assets/ea2a6ac5-bb59-4d03-9713-384a758f821d" />

Jika di F8 beberapa kali setelah breakpoint, maka terlihat ada looping yang memang disini dia membangun sebuah program. Alurnya, beberapa offset sebelumnya masih null dan ini yang terlihat kalau menggunakan static analyst, tapi ketika runtime, program akan menimpa memori tadi menggunakan kemungkinan VirtualProtect dengan opcode untuk memanggil sleep fucntion dan string yang muncul di termina. karena trnyata stuck di awal tadi itu karena program memanggil sleep method dari kernel32. Dari sini kita bisa melakukan hooking menggunakan frida script dengan JS.

```
console.log("Fridaa...");

var k32 = Process.getModuleByName("kernel32.dll");
var sleepAddr = k32.findExportByName("Sleep");

if (sleepAddr) {
    console.log("Target Address " + sleepAddr);

    Interceptor.attach(sleepAddr, {
        onEnter: function(args) {
            console.log("Sleep...: " + args[0]);
            args[0] = ptr(0); 
            
            console.log("Bypassed...");
        }
    });
} else {
    console.log("Module ga ditemukan...");
}
```

Karena kita tau kalau modul yang dipanggil adalah sleep, maka kita akan ubah argumen dari sleep tersebut yang awalnya lama mungkin beribu ms, hanya 0 ms ketika dijalankan lognya akan seperti ini

```
PS C:\Users\vewal\CTF\rev_pico> frida -f bininst1.exe -l .\final.js
     ____
    / _  |   Frida 17.6.2 - A world-class dynamic instrumentation toolkit
   | (_| |
    > _  |   Commands:
   /_/ |_|       help      -> Displays the help system
   . . . .       object?   -> Display information about 'object'
   . . . .       exit/quit -> Exit
   . . . .
   . . . .   More info at https://frida.re/docs/home/
   . . . .
   . . . .   Connected to Local System (id=local)
Spawning bininst1.exe...
Fridaa...
Target Address 0x7fff824a1980
Spawned bininst1.exe. Resuming main thread!
Hi, I have the flag for you just right here!
I'll just take a quick nap before I print it out for you, should only take me a decade or so![Local::bininst1>
zzzzzzzz....
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Sleep...: 0xfffffffe
Bypassed...
Ok, I'm Up! The flag is: cGljb0NURnt3NGtlX20zX3VwX3cxdGhfZnIxZGFfZjI3YWNjMzh9
Process terminated
[Local::bininst1.exe ]->
```

Lalu flagnya bisa kita decode karena ini simple base64. cGljb0NURnt3NGtlX20zX3VwX3cxdGhfZnIxZGFfZjI3YWNjMzh9 -> picoCTF{w4ke_m3_up_w1th_fr1da_f27acc38}
**Flag: picoCTF{w4ke_m3_up_w1th_fr1da_f27acc38}**
